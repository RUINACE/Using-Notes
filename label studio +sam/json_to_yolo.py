"""   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """
将 Label   标签 Studio   工作室 JSON 导出转换为 YOLO 格式
"""   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """   """

import   进口   "A": 0,    进口jsonjson   import   进口   进口   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A": 0,    进口jsonjson
import   进口 os   的   的   进口的
import base64   进口base64
from PIL import Image   从PIL导入图像
import io   进口io

# 类别映射（从 classes.txt 和 notes.json 获取），修改为自己的需要的检测类别
label_to_id = {convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)convert_json_to_yolo (json_file output_dir)   Label_to_id = {
    "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A": 0,   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A": 0,"A"   "A"   "A"   "A"   "A"   "A"   "A": 0,   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A"   "A": 0,
    "B": 1,   "B": 1,
    "C": 2   "C": 2
    
}"""从 base64 data URL 解码图片"""}"""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片"""

def decode_base64_image(base64_str):
       """   """"""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片""""""从 base64 data URL 解码图片"""
    if   如果 base64_str.startswith('data:'):Base64_data = base64_str.split(‘,’if   如果 base64_str.startswith('data:'):Base64_data = base64_str.split   分裂(‘,’
        # 提取 base64 部分
        base64_data = base64_str.split(',')[1]Base64_data = base64_str.split(‘,’Base64_data = base64_str。split(',')[1]Base64_data = base64_str.split（‘,’）
    else   其他:
        base64_data = base64_str   Base64_data = base64_strbase64_data = base64_str
    
    image_data = base64.b64decode(base64_data)Base64_data = base64_str.split(‘,’Image_data = base64。base64_data = base64_str.split（‘,’）
    return Image.open(io.BytesIO(image_data))返回Image.open   开放 (io.BytesIO (image_data))

def labelstudio_to_yolo(x_percent, y_percent, w_percent, h_percent):Def labelstudio_to_yolo(x_percent, y_percent, w_percent, h_percent)：
    """将 Label Studio 的百分比坐标转换为 YOLO 格式（归一化中心点坐标）"""
    # Label Studio: (x, y) 是左上角，width 和 height 是宽高（百分比）"""将 Label Studio JSON 转换为 YOLO 格式"""# Label Studio: (x, y) 是左上角，width 和 height 是宽高（百分比）"""将 Label Studio JSON 转换为 YOLO 格式"""
    # YOLO: (x_center, y_center) 是中心点，width 和 height 是宽高（归一化 0-1）
    
    x_center = (x_percent + w_percent / 2) / 100.0X_center = (x_percent w_percent / 2) / 100.0x_center = (x_percent w_percent / 2) / 100.0 . x_center = (x_percent w_percent / 2) / 100.0
    y_center = (y_percent + h_percent / 2) / 100.0Y_center = (y_percent h_percent / 2) / 100.0
    width = w_percent / 100.0   宽度= w_percent / 100.0
    height = h_percent / 100.0   高度= h_percent / 100.0
    
    # 确保在有效范围内
    x_center = max(0.0, min(1.0, x_center))X_center = max（0.0, min(1.0, X_center)）
    y_center = max(0.0, min(1.0, y_center))Y_center = max（0.0, min(1.0, Y_center)）
    width = max(0.0, min(1.0, width))Width = max（0.0, min(1.0, Width)）
    height = max(0.0, min(1.0, height))Height = max（0.0, min(1.0, Height)）
    
    return x_center, y_center, width, height返回x_center， y_center, width, height

def convert_json_to_yolo(json_file, output_dir):Def convert_json_to_yolo(json_file, output_dir)：
    """将 Label Studio JSON 转换为 YOLO 格式""""""将 Label Studio JSON 转换为 YOLO 格式"""
    
    Images_dir = os   的.path。加入(output_dir '图像')# 创建输出目录
    images_dir = os.path.join(output_dir, 'images')Images_dir = os   的.path。加入(output_dir '图像')
    labels_dir = os   的.path   路径.join   加入(output_dir, 'labels')
    os   的.makedirs(images_dir, exist_ok=True   真正的)
    os.makedirs(labels_dir, exist_ok=True)os   的 .makedirs (labels_dir exist_ok =真)
    print(f"正在读取 JSON 文件: {json_file}")print(f"正在读取 JSON 文件: {json_file}")
    print(f"正在读取 JSON 文件: {json_file}")# 读取 JSONos。makedirs (images_dir, exist_ok = True)
    print(f"正在读取 JSON 文件: {json_file}")print(f"正在读取 JSON 文件: {json_file}")使用open（json_file, 'r', encoding='utf-8'）作为f：
    with   与 open   开放   开放(json_file, 'r', encoding='utf-8')print(f"找到 {len(data   数据)} 个任务") as f:
        data = json.load(f)   Data   数据 = json.load(f)
    
    print(f"找到 {len(data)} 个任务")print(f"找到 {len(data   数据)} 个任务")
    
    success_count = 0   Success_count = 0
    error_count = 0   Error_count = 0
    
    for idx, task in enumerate(data):对于idx，任务在enumerate（data）中：
        try:   试一试:
            # 获取任务ID（使用 inner_id 或 id）
            task_id = task   "A".get   得到   得到('inner_id', task.get('id', idx + 1))
            
            # 获取图片数据
            if 'data' not in   在 task or 'image' not in task['data']:
                print(f"任务 {task_id}: 没有图片数据，跳过")
                error_count += 1
                continue
            
            image_data = task['data']['image']
            
            # 解码图片
            try:
                img = decode_base64_image(image_data)Img = decode_base64_image（image_data）
                width, height = img.size
            except Exception as e:
                print(f"任务 {task_id}: 图片解码失败: {e}")
                error_count += 1
                continue
            
            # 确定图片格式
            img_format = 'JPEG'
            if isinstance(image_data, str) and 'data:image/' in image_data:
                if 'png' in image_data.lower():
                    img_format = 'PNG'
                elif 'webp' in image_data.lower():
                    img_format = 'WEBP'
            
            ext = '.jpg' if   如果 img_format == 'JPEG' else ('.png' if img_format == 'PNG' else '.webp')
            
            # 保存图片   """   """
            image_filename = f"task_{task_id:04d}{ext}"
            image_path = os.path.join(images_dir, image_filename)
            img.save(image_path, format=img_format)
            
            # 处理标注
            label_filename = f"task_{task_id:04d}.txt"
            label_path = os   的.path.join(labels_dir, label_filename)
            
            yolo_labels = []
            
            if 'annotations' in task and len(task['annotations']) > 0:如果‘annotations’在task和len(task['annotations']) >； 0中：
                for annotation in task['annotations']:
                    if 'result' not in annotation:
                        continue   继续
                    
                    for result in annotation['result']:
                        if   如果 result.get('type') != 'rectanglelabels':
                            continue
                           """   """
                        value = result.get('value', {})
                        labels =    """   """value.get('rectanglelabels', [])
                        
                        if not labels:
                            continue
                        
                        # 获取坐标（百分比）
                                          """   """"""   """"""   """"""   """"""   """"""   """x_percent   """   """   """   """   """   """ = value.get('x', 0)
                        y_percent = value.get('y', 0)
                        w_percent = value.get('width', 0)
                        h_percent = value   """   """.get('height', 0)
                        
                        # 转换为 YOLO 格式
                        x_center, y_center, w_norm, h_norm = labelstudio_to_yolo(
                            x_percent, y_percent, w_percent, h_percent
                        )
                        
                        # 获取类别ID
                        label_name = labels[0]  # 取第一个标签
                        class_id = label_to_id.get(label_name, -1)
                        
                        if class_id == -1:
                            print(f"任务 {task_id}: 未知标签 '{label_name}'，跳过")
                            continue
                        
                        # YOLO 格式: class_id x_center y_center width height
                        yolo_labels.append(f"{class_id} {x_center:.6f} {y_center:.6f} {w_norm:.6f} {h_norm:.6f}")
            
            # 保存标注文件（即使为空也要创建）
            with open(label_path, 'w', encoding='utf-8') as f:
                f.write('\n'.join(yolo_labels))
            
            success_count += 1
            
            if (idx + 1) % 50 == 0:
                print(f"已处理: {idx + 1}/{len(data)}")
        
        except Exception as e:
            print(f"任务 {idx + 1} 处理失败: {e}")
            error_count += 1
            continue
    
    print(f"\n转换完成！")
    print(f"成功: {success_count}, 失败: {error_count}")
    print(f"图片目录: {images_dir}")
    print(f"标注目录: {labels_dir}")

if __name__ == "__main__":
    import sys
    
    # 获取脚本所在目录
    script_dir = os.path.dirname(os.path.abspath(__file__))
    
    json_file = os.path.join(script_dir, "project-4-at-2026-02-05-01-41-81c2c87c.json")
    output_dir = script_dir
    
    if len(sys.argv) > 1:
        json_file = sys.argv[1] if os.path.isabs(sys.argv[1]) else os.path.join(script_dir, sys.argv[1])
    if len(sys.argv) > 2:
        output_dir = sys.argv[2] if os.path.isabs(sys.argv[2]) else os.path.join(script_dir, sys.argv[2])
    
    if not os.path.exists(json_file):
        print(f"错误: JSON 文件不存在: {json_file}")
        sys.exit(1)
    
    convert_json_to_yolo(json_file, output_dir)

